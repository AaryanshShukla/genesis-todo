{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/saary/.gemini/antigravity/scratch/gand-faad-todo/app/api/chat/route.ts"],"sourcesContent":["import { HfInference } from '@huggingface/inference';\r\nimport { NextResponse } from 'next/server';\r\n\r\n// Use a free token if available, otherwise rely on public API limits\r\nconst HUGGINGFACE_API_KEY = process.env.HUGGINGFACE_API_KEY;\r\nconst hf = new HfInference(HUGGINGFACE_API_KEY);\r\n\r\n// Using Phi-3-mini which is fast and capable for instruction following\r\nconst MODEL_NAME = 'microsoft/Phi-3-mini-4k-instruct';\r\n\r\nexport async function POST(req: Request) {\r\n    try {\r\n        const { message } = await req.json();\r\n\r\n        if (!message) {\r\n            return NextResponse.json({ error: 'Message is required' }, { status: 400 });\r\n        }\r\n\r\n        console.log(`[AI] Generating tasks for goal: \"${message}\" using ${MODEL_NAME}`);\r\n\r\n        const prompt = `<|user|>\r\nYou are an expert project manager and productivity coach.\r\nBreak down the following goal into 6-10 actionable, specific, and sequential tasks.\r\nGoal: \"${message}\"\r\n\r\nRules:\r\n1. Each task must be clear and actionable.\r\n2. Start each task with a verb.\r\n3. Keep tasks concise (under 10 words).\r\n4. Return ONLY the list of tasks, numbered 1 to 10.\r\n5. Do not include any intro or outro text.\r\n<|end|>\r\n<|assistant|>`;\r\n\r\n        try {\r\n            const response = await hf.textGeneration({\r\n                model: MODEL_NAME,\r\n                inputs: prompt,\r\n                parameters: {\r\n                    max_new_tokens: 400,\r\n                    temperature: 0.7,\r\n                    return_full_text: false,\r\n                }\r\n            });\r\n\r\n            let generatedText = response.generated_text.trim();\r\n            console.log('[AI] Raw response:', generatedText);\r\n\r\n            // Clean up response if it contains the prompt or extra text\r\n            if (generatedText.includes('<|assistant|>')) {\r\n                generatedText = generatedText.split('<|assistant|>')[1].trim();\r\n            }\r\n\r\n            // Ensure we have a numbered list\r\n            if (!generatedText.match(/^\\d+\\./m)) {\r\n                console.warn('[AI] Response not a list, attempting to format');\r\n                // Fallback: try to split by newlines and add numbers if missing\r\n                generatedText = generatedText.split('\\n')\r\n                    .filter(line => line.trim().length > 0)\r\n                    .map((line, i) => `${i + 1}. ${line.replace(/^[-*â€¢]\\s*/, '')}`)\r\n                    .join('\\n');\r\n            }\r\n\r\n            return NextResponse.json({\r\n                response: generatedText,\r\n                source: 'dynamic-ai'\r\n            });\r\n\r\n        } catch (apiError: any) {\r\n            console.error('[AI] Hugging Face API Error:', apiError);\r\n\r\n            // If API fails, we return a specific error so the UI can handle it\r\n            // or we could try a backup model here.\r\n\r\n            // Let's try one backup model before failing\r\n            try {\r\n                console.log('[AI] Retrying with backup model: google/gemma-1.1-7b-it');\r\n                const backupResponse = await hf.textGeneration({\r\n                    model: 'google/gemma-1.1-7b-it',\r\n                    inputs: `Break down this goal into 8 actionable tasks: ${message}`,\r\n                    parameters: {\r\n                        max_new_tokens: 400,\r\n                        temperature: 0.7,\r\n                        return_full_text: false,\r\n                    }\r\n                });\r\n                return NextResponse.json({\r\n                    response: backupResponse.generated_text.trim(),\r\n                    source: 'dynamic-ai-backup'\r\n                });\r\n            } catch (backupError) {\r\n                console.error('[AI] Backup model failed:', backupError);\r\n                return NextResponse.json({\r\n                    error: 'AI service is currently overloaded. Please try again in a moment.',\r\n                    details: apiError.message\r\n                }, { status: 503 });\r\n            }\r\n        }\r\n\r\n    } catch (error) {\r\n        console.error('[AI] General Error:', error);\r\n        return NextResponse.json({ error: 'Internal Server Error' }, { status: 500 });\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;;;AAEA,qEAAqE;AACrE,MAAM,sBAAsB,QAAQ,GAAG,CAAC,mBAAmB;AAC3D,MAAM,KAAK,IAAI,2PAAW,CAAC;AAE3B,uEAAuE;AACvE,MAAM,aAAa;AAEZ,eAAe,KAAK,GAAY;IACnC,IAAI;QACA,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,IAAI,IAAI;QAElC,IAAI,CAAC,SAAS;YACV,OAAO,8MAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAsB,GAAG;gBAAE,QAAQ;YAAI;QAC7E;QAEA,QAAQ,GAAG,CAAC,CAAC,iCAAiC,EAAE,QAAQ,QAAQ,EAAE,YAAY;QAE9E,MAAM,SAAS,CAAC;;;OAGjB,EAAE,QAAQ;;;;;;;;;aASJ,CAAC;QAEN,IAAI;YACA,MAAM,WAAW,MAAM,GAAG,cAAc,CAAC;gBACrC,OAAO;gBACP,QAAQ;gBACR,YAAY;oBACR,gBAAgB;oBAChB,aAAa;oBACb,kBAAkB;gBACtB;YACJ;YAEA,IAAI,gBAAgB,SAAS,cAAc,CAAC,IAAI;YAChD,QAAQ,GAAG,CAAC,sBAAsB;YAElC,4DAA4D;YAC5D,IAAI,cAAc,QAAQ,CAAC,kBAAkB;gBACzC,gBAAgB,cAAc,KAAK,CAAC,gBAAgB,CAAC,EAAE,CAAC,IAAI;YAChE;YAEA,iCAAiC;YACjC,IAAI,CAAC,cAAc,KAAK,CAAC,YAAY;gBACjC,QAAQ,IAAI,CAAC;gBACb,gEAAgE;gBAChE,gBAAgB,cAAc,KAAK,CAAC,MAC/B,MAAM,CAAC,CAAA,OAAQ,KAAK,IAAI,GAAG,MAAM,GAAG,GACpC,GAAG,CAAC,CAAC,MAAM,IAAM,GAAG,IAAI,EAAE,EAAE,EAAE,KAAK,OAAO,CAAC,aAAa,KAAK,EAC7D,IAAI,CAAC;YACd;YAEA,OAAO,8MAAY,CAAC,IAAI,CAAC;gBACrB,UAAU;gBACV,QAAQ;YACZ;QAEJ,EAAE,OAAO,UAAe;YACpB,QAAQ,KAAK,CAAC,gCAAgC;YAE9C,mEAAmE;YACnE,uCAAuC;YAEvC,4CAA4C;YAC5C,IAAI;gBACA,QAAQ,GAAG,CAAC;gBACZ,MAAM,iBAAiB,MAAM,GAAG,cAAc,CAAC;oBAC3C,OAAO;oBACP,QAAQ,CAAC,8CAA8C,EAAE,SAAS;oBAClE,YAAY;wBACR,gBAAgB;wBAChB,aAAa;wBACb,kBAAkB;oBACtB;gBACJ;gBACA,OAAO,8MAAY,CAAC,IAAI,CAAC;oBACrB,UAAU,eAAe,cAAc,CAAC,IAAI;oBAC5C,QAAQ;gBACZ;YACJ,EAAE,OAAO,aAAa;gBAClB,QAAQ,KAAK,CAAC,6BAA6B;gBAC3C,OAAO,8MAAY,CAAC,IAAI,CAAC;oBACrB,OAAO;oBACP,SAAS,SAAS,OAAO;gBAC7B,GAAG;oBAAE,QAAQ;gBAAI;YACrB;QACJ;IAEJ,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,uBAAuB;QACrC,OAAO,8MAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAwB,GAAG;YAAE,QAAQ;QAAI;IAC/E;AACJ"}}]
}